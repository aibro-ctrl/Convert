import{u as L,a as _,l as O,r as n,m as V,z as p,j as s,B as N,o as q,w as Y,n as G,t as x}from"./index-D9PHDzQu.js";import{e as J}from"./messageEncryption-Bi4GA-wm.js";import{M as K,a as Q}from"./MessageInput-B0hk3d27.js";import{A as W,a as X,b as Z}from"./avatar-CUJzzkaW.js";import{f as $}from"./urlFix-Ck1V5EyF.js";import"./dialog-DY9M37Cv.js";import"./imageCompression-DOYNJt-j.js";function ie({dm:c,onBack:b,onUserClick:w}){const{user:u}=L(),S=_(),{tracker:a}=O(),[l,A]=n.useState([]),[C,v]=n.useState(!0),[I,m]=n.useState(null),[o,E]=n.useState(null),[R,B]=n.useState(!1),[D,F]=n.useState(!1),y=n.useRef(null),g=n.useRef(null);n.useEffect(()=>{h(),T();const e=setInterval(()=>{h()},3e3);return()=>clearInterval(e)},[c.id]),n.useEffect(()=>{const e=g.current;if(!e)return;const t=()=>{const{scrollTop:r,scrollHeight:i,clientHeight:f}=e,d=i-r-f<200;B(!d)};return e.addEventListener("scroll",t),()=>e.removeEventListener("scroll",t)},[]);const T=async()=>{const e=c.participants.find(t=>t!==u.id);if(e)try{const t=await V.getById(e);E(t.user)}catch(t){console.error("Failed to load user:",t)}},h=async()=>{try{const t=(await p.getMessages(c.id,100)).messages.filter(d=>d!=null),r=g.current,i=r?r.scrollHeight-r.scrollTop-r.clientHeight<150:!1;(l.length!==t.length||t.length>0&&l.length>0&&l[l.length-1]?.id!==t[t.length-1]?.id)&&(A(t),i&&r&&requestAnimationFrame(()=>{r.scrollTop=r.scrollHeight})),v(!1)}catch(e){console.error("Failed to load messages:",e),v(!1)}},j=()=>{y.current?.scrollIntoView({behavior:"smooth"})},U=async(e,t,r)=>{try{let i;if(!c.participants?.find(d=>d!==u?.id)){console.error("E2EE: No recipient ID found for DM"),x.error("Не удалось определить получателя сообщения.");return}i=await J(e,S),console.log("SessionCrypto: Direct message encrypted for database"),await p.sendMessage(c.id,i,t,r),m(null),!D&&a&&(await a.checkFirstMessage(),F(!0)),t==="voice"&&a&&await a.checkVoiceMessage(),t==="video"&&a&&await a.checkVideoCircleSent(),r&&a&&await a.checkReply(),a&&(await a.checkTotalMessages(),await a.checkNightMessage(),await a.checkSpeedShooter(),await a.checkMentions(e),await a.checkNewYearMessage(),await a.checkParadoxMessage(e,new Date().toISOString()),await a.checkDailyActivity()),await h(),setTimeout(j,100)}catch(i){x.error(i.message||"Ошибка отправки сообщения")}},z=async e=>{try{await G.delete(e),await h()}catch(t){console.error("Ошибка удаления:",t),x.error("Не удалось удалить сообщение")}},H=e=>{w&&w(e)};n.useEffect(()=>{(async()=>{try{await p.markAsRead(c.id)}catch(t){console.error("Failed to mark as read:",t)}})()},[c.id]);const M=u?.muted,k=u?.banned,P=!M&&!k;return s.jsxs("div",{className:"h-full flex flex-col",children:[s.jsx("div",{className:"sticky top-0 z-30 border-b p-4 pt-6 flex items-center justify-between bg-background",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(N,{variant:"ghost",size:"icon",onClick:b,children:s.jsx(q,{className:"w-5 h-5"})}),o&&s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(W,{className:"w-10 h-10",children:o.avatar?s.jsx(X,{src:$(o.avatar),alt:o.username}):s.jsx(Z,{className:"bg-primary/10 text-primary",children:(o.display_name||o.username).charAt(0).toUpperCase()})}),s.jsxs("div",{children:[s.jsx("h2",{className:"font-semibold",children:o.display_name||o.username}),s.jsxs("p",{className:"text-sm text-muted-foreground",children:["@",o.username]})]})]})]})}),s.jsxs("div",{className:"flex-1 relative",children:[s.jsx("div",{ref:g,className:"absolute inset-0 overflow-y-auto p-4",children:C?s.jsx("div",{className:"flex items-center justify-center h-full",children:"Загрузка сообщений..."}):l.length===0?s.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"Нет сообщений. Начните общение!"}):s.jsxs(s.Fragment,{children:[l.filter(e=>e!=null).map(e=>{const t=e.reply_to?l.find(r=>r&&r.id===e.reply_to):null;return s.jsx(K,{message:e,onReply:m,onPin:()=>{},onDelete:z,onUserClick:H,isPinned:!1,replyToMessage:t,onEdit:h},e.id)}),s.jsx("div",{ref:y})]})}),R&&s.jsx("div",{className:"absolute bottom-4 right-4 z-20",children:s.jsx(N,{onClick:j,size:"icon",className:"rounded-full shadow-lg hover:shadow-xl transition-shadow",variant:"secondary",children:s.jsx(Y,{className:"w-5 h-5"})})})]}),s.jsx("div",{className:"sticky bottom-0 z-20 bg-background border-t",children:k?s.jsx("div",{className:"p-4 bg-destructive/10 text-center",children:s.jsx("p",{className:"text-destructive",children:"Вы заблокированы и не можете отправлять сообщения"})}):M?s.jsx("div",{className:"p-4 bg-warning/10 text-center",children:s.jsx("p",{className:"text-warning",children:"Вы в муте и не можете отправлять сообщения"})}):s.jsx(Q,{onSend:U,replyingTo:I,onCancelReply:()=>m(null),disabled:!P})})]})}export{ie as DirectMessageChat};
