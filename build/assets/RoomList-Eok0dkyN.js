import{u as U,a as q,r,b as c,t as h,j as s,C as $,c as P,B as x,P as G,L as T,I as K,d as Q,U as V,e as X,f as d,E as Y,A as Z,H as ee,g as z,T as se}from"./index-D9PHDzQu.js";import{d as ae}from"./messageEncryption-Bi4GA-wm.js";import{R as te}from"./RoomManagement-NxqnCbJQ.js";import{D as ne,a as ie,b as re,c as le,d as ce,e as de}from"./dialog-DY9M37Cv.js";function he({onSelectRoom:N}){const{user:n,godModeEnabled:o}=U(),w=q(),[u,_]=r.useState([]),[E,A]=r.useState(!0),[F,C]=r.useState(!1),[j,D]=r.useState(""),[v,k]=r.useState("private"),[I,f]=r.useState(null),[L,m]=r.useState(!1),[R,S]=r.useState(null),[O,M]=r.useState(new Map);r.useEffect(()=>{n?.role==="admin"&&c.cleanupAzkaban().catch(console.error),g();const e=setInterval(g,15e3);return()=>clearInterval(e)},[o]),r.useEffect(()=>{(async()=>{if(u.length===0){M(new Map);return}const t=new Map;for(const a of u)if(a.last_message&&a.last_message.content)try{const i=a.last_message.content;let p=!1;try{const b=JSON.parse(i);p=b&&b.version&&b.ciphertext}catch{p=!1}if(!p){t.set(a.id,i);continue}const y={id:a.last_message.id||"",content:i,sender_id:a.last_message.sender_id||"",room_id:a.id,type:a.last_message.type||"text",created_at:a.last_message.created_at||new Date().toISOString()},J=await ae(i,w,y);t.set(a.id,J)}catch(i){console.error(`Failed to decrypt preview for room ${a.id}:`,i),t.set(a.id,a.last_message.content)}M(t)})()},[u,w]);const g=async()=>{try{const e=await c.getAll(o);if(_(e.rooms),n?.banned){const t=e.rooms.find(a=>a.name==="ðŸ”’ ÐÐ·ÐºÐ°Ð±Ð°Ð½");if(t)try{await c.join(t.id,!1),N(t),h.error("Ð’Ñ‹ Ð·Ð°Ð±Ð°Ð½ÐµÐ½Ñ‹ Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ñ‹ Ð² ÐÐ·ÐºÐ°Ð±Ð°Ð½")}catch(a){console.error("Failed to auto-join Azkaban:",a)}}}catch(e){console.error("Failed to load rooms:",e)}finally{A(!1)}},B=async e=>{if(e.preventDefault(),!!j.trim())try{const t=await c.create(j,v);_([...u,t]),C(!1),D("")}catch(t){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹:",t)}},H=async e=>{if(!e.members.includes(n.id)&&!o){console.log(`User ${n.id} (${n.username}) joining room ${e.id} (${e.name}, type: ${e.type})`);try{const t=await c.join(e.id,o);console.log("Join result received, members count:",t?.members?.length),t&&(e=t,console.log(`Room updated after join, user ${n.id} is member: ${e.members.includes(n.id)}`)),g()}catch(t){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ:",t),h.error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ñ‚ÑŒÑÑ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ: "+(t.message||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"));return}}console.log(`Selecting room ${e.id} (${e.name}), user ${n.id} is member: ${e.members.includes(n.id)}, godMode: ${o}`),N(e)},W=async e=>{if(!(e.type==="public"&&n&&["admin","moderator"].includes(n.role)||e.type==="private"&&e.created_by===n?.id||n&&n.role==="admin")){h.error("Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÑ‚Ð¾Ð¹ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹");return}if(confirm(`Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ "${e.name}"? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`))try{await c.delete(e.id),h.success("ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð°"),g(),m(!1),f(null)}catch(a){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹:",a),h.error(a.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ")}};if(E)return s.jsxs("div",{className:"h-full flex flex-col",children:[s.jsx("div",{className:"sticky top-0 z-30 bg-background p-4 border-b flex items-center justify-between",children:s.jsx("h2",{className:"text-xl",children:"ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹"})}),s.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:[1,2,3,4].map(e=>s.jsx($,{className:"animate-pulse",children:s.jsx(P,{className:"p-4",children:s.jsxs("div",{className:"space-y-3",children:[s.jsx("div",{className:"h-5 bg-muted rounded w-2/3"}),s.jsx("div",{className:"h-4 bg-muted rounded w-full"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("div",{className:"h-6 bg-muted rounded w-20"}),s.jsx("div",{className:"h-6 bg-muted rounded w-24"})]})]})})},e))})]});if(R)return s.jsx(te,{room:R,onBack:()=>S(null)});let l=u.filter(e=>e.type!=="dm"&&!e.name.includes("â­ Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ")&&!e.name.includes("Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ"));return n?.banned?l=l.filter(e=>e.name==="ðŸ”’ ÐÐ·ÐºÐ°Ð±Ð°Ð½"):l=l.filter(e=>e.name!=="ðŸ”’ ÐÐ·ÐºÐ°Ð±Ð°Ð½"),l=l.sort((e,t)=>{if(e.type!==t.type)return e.type==="public"?-1:1;const a=e.pinned_message_id?1:0,i=t.pinned_message_id?1:0;if(a!==i)return i-a;const p=e.last_activity||e.created_at,y=t.last_activity||t.created_at;return new Date(y).getTime()-new Date(p).getTime()}),s.jsxs("div",{className:"h-full flex flex-col",children:[s.jsxs("div",{className:"sticky top-0 z-30 bg-background p-4 border-b flex items-center justify-between",children:[s.jsx("h2",{className:"text-xl",children:"ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹"}),!n?.banned&&s.jsxs(ne,{open:F,onOpenChange:C,children:[s.jsx(ie,{asChild:!0,children:s.jsxs(x,{size:"sm",children:[s.jsx(G,{className:"w-4 h-4 mr-2"}),"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"]})}),s.jsxs(re,{children:[s.jsxs(le,{children:[s.jsx(ce,{children:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ"}),s.jsx(de,{children:n?.role==="admin"?"ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¸ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹":"Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½ÑƒÑŽ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ"})]}),s.jsxs("form",{onSubmit:B,className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(T,{htmlFor:"roomName",children:"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹"}),s.jsx(K,{id:"roomName",value:j,onChange:e=>D(e.target.value),placeholder:"ÐœÐ¾Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð°",required:!0})]}),n?.role==="admin"&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(T,{children:"Ð¢Ð¸Ð¿ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹"}),s.jsxs("div",{className:"flex gap-4",children:[s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"radio",value:"public",checked:v==="public",onChange:e=>k("public")}),"ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð°Ñ"]}),s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"radio",value:"private",checked:v==="private",onChange:e=>k("private")}),"ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ð°Ñ"]})]})]}),s.jsx(x,{type:"submit",className:"w-full",children:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ"})]})]})]})]}),s.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:l.length===0?s.jsx("div",{className:"text-center text-muted-foreground py-8",children:"ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð½Ð°Ñ‚. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¿ÐµÑ€Ð²ÑƒÑŽ!"}):l.map(e=>{const t=e.type==="public"&&n&&["admin","moderator"].includes(n.role)||e.type==="private"&&e.created_by===n?.id;return s.jsxs("div",{className:"relative",children:[s.jsx($,{className:"cursor-pointer hover:bg-accent transition-colors",onClick:()=>H(e),onContextMenu:a=>{t&&(a.preventDefault(),f(e),m(!0))},children:s.jsx(P,{className:"p-4",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs(Q,{className:"text-base flex items-center gap-2",children:[e.type==="public"?s.jsx(V,{className:"w-4 h-4"}):s.jsx(X,{className:"w-4 h-4"}),e.name,e.isGodMode&&s.jsxs(d,{variant:"secondary",className:"ml-2",children:[s.jsx(Y,{className:"w-3 h-3 mr-1"}),"Ð“Ð»Ð°Ð· Ð‘Ð¾Ð³Ð°"]})]}),e.last_message&&s.jsxs("p",{className:"text-sm text-muted-foreground mt-1 truncate",children:[s.jsxs("span",{className:"font-medium",children:[e.last_message.sender_username,":"]})," ",(()=>{let a=O.get(e.id);a||(a=e.last_message.content),a&&a.trim().startsWith("{")&&a.includes('"version"')&&a.includes('"ciphertext"')&&(a=e.last_message.content);const i=e.last_message.type;if(i==="video")return"ðŸŽ¥ Ð’Ð¸Ð´ÐµÐ¾";if(i==="voice"||i==="audio")return"ðŸŽ¤ Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ";if(a.startsWith("![")&&a.includes("]("))return"ðŸ–¼ï¸ Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ";if(a.startsWith("http://")||a.startsWith("https://")){if(a.includes("/voice/")||a.includes("/audio/")||a.includes("voice")||a.includes("audio"))return"ðŸŽ¤ Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ";if(a.includes("/video/")||a.includes("video"))return"ðŸŽ¥ Ð’Ð¸Ð´ÐµÐ¾";if(a.includes("/images/")||a.includes("/image/")||a.includes("images")||a.includes("image"))return"ðŸ–¼ï¸ Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ";if(a.includes("/storage/v1/object/"))return"ðŸ“Ž Ð¤Ð°Ð¹Ð»"}return a.substring(0,50)})()]}),s.jsxs("div",{className:"flex gap-2 mt-2 flex-wrap",children:[s.jsx(d,{variant:e.type==="public"?"default":"outline",children:e.type==="public"?"ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð°Ñ":"ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ð°Ñ"}),s.jsxs(d,{variant:"secondary",children:[e.members.length," ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"]}),e.unread_count&&e.unread_count[n.id]>0&&s.jsxs(d,{variant:"default",className:"bg-red-500 text-white border-2 border-red-600",children:[e.unread_count[n.id]," Ð½Ð¾Ð²Ñ‹Ñ…"]}),e.unread_mentions&&e.unread_mentions[n.id]>0&&s.jsxs(d,{variant:"destructive",className:"flex items-center gap-1",children:[s.jsx(Z,{className:"w-3 h-3"}),e.unread_mentions[n.id]]}),e.unread_reactions&&e.unread_reactions[n.id]>0&&s.jsxs(d,{variant:"default",className:"flex items-center gap-1 bg-pink-500",children:[s.jsx(ee,{className:"w-3 h-3"}),e.unread_reactions[n.id]]})]})]}),t&&s.jsx(x,{variant:"ghost",size:"sm",className:"ml-2 shrink-0",onClick:a=>{a.stopPropagation(),f(e),m(!0)},children:s.jsx(z,{className:"w-4 h-4"})})]})})}),L&&I?.id===e.id&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>{m(!1),f(null)}}),s.jsx("div",{className:"absolute top-full left-0 mt-1 w-48 bg-popover border rounded-md shadow-lg z-50 p-2",children:s.jsxs("div",{className:"space-y-1",children:[s.jsxs(x,{variant:"ghost",className:"w-full justify-start",onClick:a=>{a.stopPropagation(),S(e),m(!1)},children:[s.jsx(z,{className:"w-4 h-4 mr-2"}),"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"]}),s.jsxs(x,{variant:"ghost",className:"w-full justify-start text-destructive hover:text-destructive hover:bg-destructive/10",onClick:a=>{a.stopPropagation(),W(e)},children:[s.jsx(se,{className:"w-4 h-4 mr-2"}),"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"]})]})})]})]},e.id)})})]})}export{he as RoomList};
