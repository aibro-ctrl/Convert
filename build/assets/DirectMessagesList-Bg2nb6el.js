import{u as X,a as Y,r as c,z as k,m as P,t as h,j as e,C as A,c as T,B as f,P as Z,I as ee,q as se,M as E,T as te,d as ae,f as re,b as ne}from"./index-D9PHDzQu.js";import{d as ie}from"./messageEncryption-Bi4GA-wm.js";import{D as ce,a as oe,b as le,c as de,d as ue,e as me}from"./dialog-DY9M37Cv.js";import{A as z,a as $,b as F}from"./avatar-CUJzzkaW.js";import{f as O}from"./urlFix-Ck1V5EyF.js";function ve({onSelectDM:w}){const{user:u}=X(),N=Y(),[m,B]=c.useState([]),[x,H]=c.useState(!0),[b,D]=c.useState(!1),[R,_]=c.useState(!1),[g,M]=c.useState(""),[C,j]=c.useState([]),[S,W]=c.useState(new Map),[L,I]=c.useState(new Map);c.useEffect(()=>{p();const s=setInterval(p,15e3);return()=>clearInterval(s)},[]),c.useEffect(()=>{(async()=>{if(m.length===0){I(new Map);return}const a=new Map;for(const r of m)if(r.last_message&&r.last_message.content)try{const t=r.last_message.content;let n=!1;try{const d=JSON.parse(t);n=d&&d.version&&d.ciphertext}catch{n=!1}if(!n){a.set(r.id,t);continue}const o={id:r.last_message.id||"",content:t,sender_id:r.last_message.sender_id||"",room_id:r.id,type:r.last_message.type||"text",created_at:r.last_message.created_at||new Date().toISOString()},i=await ie(t,N,o);a.set(r.id,i)}catch(t){console.error(`Failed to decrypt preview for DM ${r.id}:`,t),a.set(r.id,r.last_message.content)}I(a)})()},[m,N]);const p=async()=>{const s=Date.now();try{const a=await k.getAll();B(a.dms);const r=a.dms.flatMap(i=>i.participants.filter(d=>d!==u.id)),t=[...new Set(r)],n=new Map(S),o=10;for(let i=0;i<t.length;i+=o){const V=t.slice(i,i+o).map(l=>P.getById(l).then(y=>({userId:l,user:y.user})).catch(y=>(console.error(`Failed to load user ${l}:`,y),null)));(await Promise.all(V)).forEach(l=>{l&&n.set(l.userId,l.user)}),W(new Map(n))}console.log(`DMs loaded in ${Date.now()-s}ms`),D(!1)}catch(a){console.error("Failed to load DMs:",a),D(!0),x&&h.error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚Ñ‹")}finally{H(!1)}},v=async s=>{const a=s??g;if(!a.trim()||a.length<2){j([]);return}try{const t=(await P.search(a)).users.filter(n=>n.id!==u.id);j(t)}catch(r){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð¸ÑÐºÐ°:",r),h.error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹")}},q=async s=>{try{const a=await k.create(s.id);_(!1),M(""),j([]),await p(),w(a)}catch(a){console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‡Ð°Ñ‚Ð°:",a),h.error(a.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‡Ð°Ñ‚")}},Q=s=>{w(s)},U=async(s,a)=>{if(a.stopPropagation(),!!confirm("Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ñ‡Ð°Ñ‚? Ð’ÑÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹."))try{await ne.delete(s),h.success("Ð§Ð°Ñ‚ ÑƒÐ´Ð°Ð»ÐµÐ½"),await p()}catch(r){console.error("Error deleting DM:",r),h.error(r.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚")}};if(b&&!x)return null;if(x)return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"sticky top-0 z-30 bg-background p-4 border-b flex items-center justify-between",children:e.jsx("h2",{className:"text-xl",children:"Ð›Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:[1,2,3,4,5].map(s=>e.jsx(A,{className:"animate-pulse",children:e.jsx(T,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-muted shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-muted rounded w-1/2"})]})]})})},s))})]});const J=s=>s.participants.find(a=>a!==u.id),K=s=>{const a=J(s);return a?S.get(a):null},G=s=>{const a=new Date(s),t=new Date().getTime()-a.getTime(),n=Math.floor(t/6e4),o=Math.floor(n/60),i=Math.floor(o/24);return n<1?"Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾":n<60?`${n} Ð¼Ð¸Ð½`:o<24?`${o} Ñ‡`:i===1?"Ð²Ñ‡ÐµÑ€Ð°":i<7?`${i} Ð´`:a.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})};return b&&!x?null:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"sticky top-0 z-30 bg-background p-4 border-b flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl",children:"Ð›Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"}),e.jsxs(ce,{open:R,onOpenChange:_,children:[e.jsx(oe,{asChild:!0,children:e.jsxs(f,{size:"sm",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"ÐÐ¾Ð²Ñ‹Ð¹ Ñ‡Ð°Ñ‚"]})}),e.jsxs(le,{children:[e.jsxs(de,{children:[e.jsx(ue,{children:"ÐÐ¾Ð²Ñ‹Ð¹ Ñ‡Ð°Ñ‚"}),e.jsx(me,{children:"ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ee,{value:g,onChange:s=>{M(s.target.value),v(s.target.value)},placeholder:"ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ...",onKeyDown:s=>s.key==="Enter"&&v()}),e.jsx(f,{onClick:()=>v(),children:e.jsx(se,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:[C.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded hover:bg-accent transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"w-10 h-10",children:s.avatar?e.jsx($,{src:O(s.avatar),alt:s.username}):e.jsx(F,{className:"bg-primary/10 text-primary",children:(s.display_name||s.username).charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.display_name||s.username}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["@",s.username]})]})]}),e.jsxs(f,{size:"sm",onClick:()=>q(s),children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ"]})]},s.id)),g&&C.length===0&&e.jsx("div",{className:"text-center text-muted-foreground py-4",children:"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"})]})]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:m.length===0?e.jsxs("div",{className:"text-center text-muted-foreground py-8",children:[e.jsx(E,{className:"w-12 h-12 mx-auto mb-4 opacity-20"}),e.jsx("p",{children:"ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð¾Ð²"}),e.jsx("p",{className:"text-sm mt-2",children:"ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð²Ñ‹ÑˆÐµ"})]}):m.map(s=>{const a=K(s),r=s.unread_count?.[u.id]||0;return a?e.jsxs(A,{className:"relative cursor-pointer hover:bg-accent transition-colors group",onClick:()=>Q(s),children:[e.jsx(f,{variant:"ghost",size:"icon",className:"absolute top-2 right-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-destructive hover:text-destructive-foreground",onClick:t=>U(s.id,t),title:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚",children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx(T,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"w-12 h-12 shrink-0",children:a.avatar?e.jsx($,{src:O(a.avatar),alt:a.username}):e.jsx(F,{className:"bg-primary/10 text-primary",children:(a.display_name||a.username).charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(ae,{className:"text-base truncate",children:a.display_name||a.username}),s.last_activity&&e.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:G(s.last_activity)})]}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:["@",a.username]}),s.last_message&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1 truncate",children:[s.last_message.sender_id===u.id&&"Ð’Ñ‹: ",(()=>{let t=L.get(s.id);if(t||(t=s.last_message.content),t&&t.trim().startsWith("{")&&t.includes('"version"')&&t.includes('"ciphertext"')&&(t=s.last_message.content),t.startsWith("![")&&t.includes("]("))return"ðŸ–¼ï¸ Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ";const n=s.last_message.type;if(n==="video")return"ðŸŽ¥ Ð’Ð¸Ð´ÐµÐ¾";if(n==="voice"||n==="audio")return"ðŸŽ¤ Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ";if(t.startsWith("http://")||t.startsWith("https://")){if(t.includes("/voice/")||t.includes("/audio/")||t.includes("voice")||t.includes("audio"))return"ðŸŽ¤ Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ";if(t.includes("/video/")||t.includes("video"))return"ðŸŽ¥ Ð’Ð¸Ð´ÐµÐ¾";if(t.includes("/images/")||t.includes("/image/")||t.includes("images")||t.includes("image"))return"ðŸ–¼ï¸ Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ";if(t.includes("/storage/v1/object/"))return"ðŸ“Ž Ð¤Ð°Ð¹Ð»"}return t.substring(0,40)})()]}),r>0&&e.jsxs(re,{variant:"default",className:"mt-2 bg-blue-500",children:[r," ",r===1?"Ð½Ð¾Ð²Ð¾Ðµ":"Ð½Ð¾Ð²Ñ‹Ñ…"]})]})]})})]},s.id):null})})]})}export{ve as DirectMessagesList};
