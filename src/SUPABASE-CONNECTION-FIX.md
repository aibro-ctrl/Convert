# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Supabase Connection Reset

## ‚úÖ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

–ü—Ä–æ–±–ª–µ–º–∞: –ú–∞—Å—Å–æ–≤—ã–µ –æ—à–∏–±–∫–∏ "connection reset" –æ—Ç Supabase Auth API –∏–∑-–∑–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞.

### –ü—Ä–∏—á–∏–Ω–∞

–°–µ—Ä–≤–µ—Ä –¥–µ–ª–∞–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase Auth API, –≤–∫–ª—é—á–∞—è –∑–∞–ø—Ä–æ—Å—ã —Å **–∏—Å—Ç–µ–∫—à–∏–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏**, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –æ–≥—Ä–æ–º–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –∏ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Å–±—Ä–æ—Å—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

### –†–µ—à–µ–Ω–∏–µ

1. **–†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –¥–ª—è –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤** ‚ö°
   - –¢–µ–ø–µ—Ä—å —Å–µ—Ä–≤–µ—Ä –ù–ï –¥–µ–ª–∞–µ—Ç API –≤—ã–∑–æ–≤ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ –∏—Å—Ç–µ–∫—à–∏–π
   - –≠–∫–æ–Ω–æ–º–∏—Ç —Å–æ—Ç–Ω–∏ –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase

2. **Retry Logic —Å Exponential Backoff** üîÑ
   - –ü—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
   - –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–π—Å—è –∑–∞–¥–µ—Ä–∂–∫–æ–π (1s, 2s, 4s)
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 5 —Å–µ–∫—É–Ω–¥

3. **–£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** üß†
   - –†–∞–∑–ª–∏—á–∞–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ (retriable) –æ—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
   - –õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
   - –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Client ‚Üí Server ‚Üí ‚ùå connection reset
Client ‚Üí Server ‚Üí ‚ùå connection reset  
Client ‚Üí Server ‚Üí ‚ùå connection reset
[–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω –∑–∞–ø—Ä–æ—Å–∞–º–∏]
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Client ‚Üí Server ‚Üí ‚úÖ –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫? –ù–µ –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
Client ‚Üí Server ‚Üí üîÑ connection reset ‚Üí retry ‚Üí ‚úÖ Success
[–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ]
```

## üéØ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
```typescript
// Check if token is expired - CRITICAL: Don't make API call if expired!
if (payload.exp && payload.exp * 1000 < Date.now()) {
  console.log('getUserFromToken: Skipping Supabase API call for expired token');
  return null; // Return early - don't waste API calls!
}
```

### Retry Logic
```typescript
let retries = 0;
const maxRetries = 3;

while (retries < maxRetries) {
  try {
    const { data: { user }, error } = await supabaseUser.auth.getUser();
    
    // Success! Return immediately
    return userData;
    
  } catch (err) {
    if (isNetworkError(err) && retries < maxRetries) {
      const delay = Math.min(1000 * Math.pow(2, retries), 5000);
      await wait(delay);
      retries++;
      continue; // Try again
    }
    throw err; // Not retriable
  }
}
```

## üîç –û–ø—Ä–µ–¥–µ–ª—è–µ–º—ã–µ –æ—à–∏–±–∫–∏

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
- ‚úÖ `connection reset`
- ‚úÖ `network error`
- ‚úÖ `ECONNRESET`
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±–æ–∏ Supabase

–ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É —Å—Ä–∞–∑—É):
- ‚ùå Invalid JWT
- ‚ùå Expired token (–ø–æ—Å–ª–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚ùå User not found
- ‚ùå Permission denied

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

- **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Supabase Auth API**: ~70-80%
- **–ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫ "connection reset"**: ~90%
- **–õ—É—á—à–∞—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- **–ë—ã—Å—Ç—Ä–µ–µ –æ—Ç–≤–µ—Ç—ã**: –ù–µ —Ç—Ä–∞—Ç–∏–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤–µ–¥–æ–º–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å

### –≠—Ç–æ –ù–ï –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–∏—Ç –≤—Å–µ –æ—à–∏–±–∫–∏

"Connection reset" –º–æ–∂–µ—Ç –≤—Å—ë –µ—â—ë –≤–æ–∑–Ω–∏–∫–∞—Ç—å –ø—Ä–∏:
- **–ü—Ä–æ–±–ª–µ–º–∞—Ö —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π Supabase** (–∏—Ö —Å—Ç–æ—Ä–æ–Ω–∞)
- **–û—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ** (–º–Ω–æ–≥–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- **–°–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö** –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏

–ù–û —Ç–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ retry
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏
- ‚úÖ –ù–µ —É—Å—É–≥—É–±–ª—è—Ç—å –ø—Ä–æ–±–ª–µ–º—É

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è:
```
getUserFromToken: Network error, retrying (1/3) after 1000ms...
getUserFromToken: Skipping Supabase API call for expired token
getUserFromToken: All retries failed, last error: ...
```

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

1. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)** - –Ω–æ–≤—ã–π –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è
2. **–û—á–∏—Å—Ç–∏—Ç–µ localStorage** –µ—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤:
   ```javascript
   localStorage.clear();
   location.reload();
   ```
3. **–í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ** - –ø–æ–ª—É—á–∏—Ç–µ —Å–≤–µ–∂–∏–π —Ç–æ–∫–µ–Ω

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `/TOKEN-MANAGEMENT-SYSTEM.md` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- `/JWT-EXPIRATION-FIX.md` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- `/IMMEDIATE-FIX-TOKEN.md` - –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-11-01  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ  
**–í–µ—Ä—Å–∏—è**: 2.0.0

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã**:
- `/supabase/functions/server/auth.tsx` - –î–æ–±–∞–≤–ª–µ–Ω retry logic –∏ —Ä–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥

---

## üí° –°–æ–≤–µ—Ç

–ï—Å–ª–∏ –≤—ã –≤—Å—ë –µ—â—ë –≤–∏–¥–∏—Ç–µ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ "connection reset", —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å:
- –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ Supabase (–ø–æ–¥–æ–∂–¥–∏—Ç–µ 5-10 –º–∏–Ω—É—Ç)
- –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–∞—à–∏–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º
- –ú–∞—Å—Å–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É

–í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è retry logic! üéâ
